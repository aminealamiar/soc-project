---
- name: Ensure certs directory exists
  file:
    path: "{{ wazuh_cert_dir }}"
    state: directory
    mode: '0755'

- name: Download wazuh-certs-tool.sh
  get_url:
    url: "https://packages.wazuh.com/4.12/wazuh-certs-tool.sh"
    dest: "{{ wazuh_cert_dir }}/wazuh-certs-tool.sh"
    mode: '0755'

- name: Deploy Wazuh cert configuration
  copy:
    dest: "{{ wazuh_cert_dir }}/config.yml"
    content: |
      nodes:
        indexer:
          - name: wazuh.indexer
            ip: 127.0.0.1

        server:
          - name: wazuh.manager
            ip: 127.0.0.1

        dashboard:
          - name: wazuh.dashboard
            ip: 127.0.0.1

- name: Generate Wazuh certificates (idempotent)
  command: "./wazuh-certs-tool.sh -A"
  args:
    chdir: "{{ wazuh_cert_dir }}"
    creates: "{{ wazuh_cert_dir }}/wazuh-certificates/root-ca.pem"

- name: Check if certificates directory exists
  stat:
    path: "{{ wazuh_cert_dir }}/wazuh-certificates"
  register: cert_stat_result

- name: Fix ownership of generated certificates directory
  file:
    path: "{{ wazuh_cert_dir }}/wazuh-certificates"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'
    recurse: yes
  when: cert_stat_result.stat.exists

- name: Install pip (for Python package management)
  package:
    name: "{{ item }}"
    state: present
  become: yes
  loop:
    - python3-pipx
    - python3-setuptools
  ignore_errors: yes

- name: Install Docker Python SDK
  pip:
    name: docker
    state: present
    executable: pipx
  become: yes

- name: Read certificate files from target host
  slurp:
    src: "{{ wazuh_cert_dir }}/wazuh-certificates/{{ item }}"
  register: cert_content
  loop:
    - root-ca.pem
    - wazuh.manager.pem
    - wazuh.manager-key.pem
    - wazuh.indexer.pem
    - wazuh.indexer-key.pem
    - wazuh.dashboard.pem
    - wazuh.dashboard-key.pem
  when: cert_stat_result.stat.exists

- name: Create Docker secrets from generated certs
  docker_secret:
    name: "{{ item.item }}"
    state: present
    data: "{{ item.content | b64decode }}"
  loop: "{{ cert_content.results }}"
  when: cert_stat_result.stat.exists and not item.skipped | default(false)

- name: Deploy Wazuh stack file
  template:
    src: wazuh-stack.yml.j2
    dest: "{{ wazuh_stack_file }}"

- name: Deploy Wazuh stack
  command: docker stack deploy -c {{ wazuh_stack_file }} wazuh
